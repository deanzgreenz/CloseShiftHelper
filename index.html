<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Close Shift Helper</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
    .tabs { margin-bottom: 1rem; }
    .tabs button { padding: 0.5rem 1rem; margin-right: 0.5rem; }
    .section { display: none; }
    .section.active { display: block; }
    label { display: block; margin: 0.5rem 0 0.2rem; }
    input, select { width: 100%; padding: 0.5rem; margin-bottom: 1rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: center; }
    .preview { background: #f9f9f9; border: 1px solid #ccc; padding: 1rem; font-family: monospace; }
    button.save { padding: 0.75rem 1.5rem; font-size: 1rem; }
  </style>
</head>
<body>
  <h1>Close Shift Helper</h1>
  <div class="tabs">
    <button id="tab-close">Close Shift</button>
    <button id="tab-daily">Complete Daily Deposit</button>
  </div>

  <!-- CLOSE SHIFT SECTION -->
  <div id="close-section" class="section">
    <h2>Close Shift</h2>
    <label>Date</label><input type="text" id="cs-date" readonly>
    <label>Store</label><input type="text" id="cs-store" readonly>
    <h3>Coin Reset Par = $20</h3>
    <label>Pennies</label><input type="number" id="cs-pennies" oninput="recalcClose()">
    <label>Nickels</label><input type="number" id="cs-nickels" oninput="recalcClose()">
    <label>Dimes</label><input type="number" id="cs-dimes" oninput="recalcClose()">
    <label>Quarters</label><input type="number" id="cs-quarters" oninput="recalcClose()">
    <label>Dollar Coins</label><input type="number" id="cs-dollars" oninput="recalcClose()">
    <div id="cs-adjustment"></div>
    <h3>Bills (After $480 removed for Reset Till)</h3>
    <label>Total Bills</label><input type="number" id="cs-bills" oninput="recalcClose()">
    <label>Total Coin Adjustment</label><input type="text" id="cs-coin-adjust" readonly>
    <label>Closed Shift Drop Total</label><input type="text" id="cs-drop-total" readonly>
  </div>

  <!-- DAILY DEPOSIT SECTION -->
  <div id="daily-section" class="section">
    <h2>Complete Daily Deposit</h2>
    <label>Date</label><input type="text" id="dd-date" readonly>
    <label>Store</label><input type="text" id="dd-store" readonly>
    <label>Total Tendered</label><input type="number" id="dd-tendered" readonly>
    <label>Tax Collected (Rounded)</label><input type="number" id="dd-tax" readonly>
    <label>Change from Change Bag</label><input type="number" id="dd-change" oninput="recalcDaily()">
    <h3>Vendor Payouts / Bills</h3>
    <table><thead><tr><th>Vendor</th><th>Amount</th></tr></thead><tbody id="dd-vendors">
      <tr><td><input type="text" placeholder="Vendor A"></td><td><input type="number" class="dd-vamt" oninput="recalcDaily()"></td></tr>
      <tr><td><input type="text" placeholder="Vendor B"></td><td><input type="number" class="dd-vamt" oninput="recalcDaily()"></td></tr>
      <tr><td><input type="text" placeholder="Vendor C"></td><td><input type="number" class="dd-vamt" oninput="recalcDaily()"></td></tr>
      <tr><td><input type="text" placeholder="Vendor D"></td><td><input type="number" class="dd-vamt" oninput="recalcDaily()"></td></tr>
      <tr><td><input type="text" placeholder="Vendor E"></td><td><input type="number" class="dd-vamt" oninput="recalcDaily()"></td></tr>
    </tbody></table>
    <label>Notes</label><input type="text" id="dd-notes">
    <div class="preview" id="dd-preview"></div>
    <button class="save" onclick="downloadDaily()">Save Daily Deposit Sheet</button>
  </div>

  <script>
    // TAB SWITCH
    const tabClose = document.getElementById('tab-close'),
          tabDaily = document.getElementById('tab-daily'),
          secClose = document.getElementById('close-section'),
          secDaily = document.getElementById('daily-section');
    function showClose(){ secClose.classList.add('active'); secDaily.classList.remove('active'); }
    function showDaily(){ secDaily.classList.add('active'); secClose.classList.remove('active'); }
    tabClose.onclick=showClose; tabDaily.onclick=showDaily;

    // INITIALIZE URL PARAMS + DATE/STORE
    const params = new URLSearchParams(window.location.search);
    const store = params.get('store')||'Unknown';
    const tender = parseFloat(params.get('tendered'))||0;
    const tax    = parseInt(params.get('tax'))||0;
    const today  = new Date().toISOString().split('T')[0];
    ['cs-date','dd-date'].forEach(id=>document.getElementById(id).value=today);
    ['cs-store','dd-store'].forEach(id=>document.getElementById(id).value=store);
    document.getElementById('dd-tendered').value=tender.toFixed(2);
    document.getElementById('dd-tax').value=tax;
    showClose(); // default

    // CLOSE SHIFT LOGIC with OK/Add/Remove
    const csPar=20;
    function recalcClose(){
      const pennies  = parseFloat(document.getElementById('cs-pennies').value)||0;
      const nickels  = parseFloat(document.getElementById('cs-nickels').value)||0;
      const dimes    = parseFloat(document.getElementById('cs-dimes').value)||0;
      const quarters = parseFloat(document.getElementById('cs-quarters').value)||0;
      const dollars  = parseFloat(document.getElementById('cs-dollars').value)||0;
      const coinsTotal = pennies + nickels + dimes + quarters + dollars;
      const rawAdjust = coinsTotal - csPar;
      const coinAdjust = rawAdjust.toFixed(2);
      document.getElementById('cs-coin-adjust').value = coinAdjust;
      let msg;
      if (Math.abs(rawAdjust) < 0.005) {
        msg = '<strong>OK</strong> â€“ Par Level';
      } else if (rawAdjust > 0) {
        msg = `<strong>Remove</strong> $${rawAdjust.toFixed(2)}`;
      } else {
        msg = `<strong>Add</strong> $${Math.abs(rawAdjust).toFixed(2)}`;
      }
      document.getElementById('cs-adjustment').innerHTML = msg;
      const bills = parseFloat(document.getElementById('cs-bills').value)||0;
      const drop = (bills + Math.max(rawAdjust,0)).toFixed(2);
      document.getElementById('cs-drop-total').value = drop;
    }

    // DAILY DEPOSIT LOGIC
    function sumV(){ return Array.from(document.getElementsByClassName('dd-vamt'))
      .reduce((a,i)=>a+(parseFloat(i.value)||0),0); }
    function recalcDaily(){
      const netPOS = tender - tax;
      const vendorSum = sumV();
      const netO = netPOS - vendorSum;
      const change = parseFloat(document.getElementById('dd-change').value)||0;
      const diff = (change - netO).toFixed(2);
      document.getElementById('dd-preview').innerHTML = `
        Net from POS:   $${netPOS.toFixed(2)}<br>
        Bills Paid:     $${vendorSum.toFixed(2)}<br>
        Net Owed:       $${netO.toFixed(2)}<br>
        Cash from Bag:  $${change.toFixed(2)}<br>
        Discrepancy:    $${diff}`;
    }
    recalcDaily();

    // DOWNLOAD DAILY
    function downloadDaily(){
      const ws_data = [
        ['Date','Store','Net POS','Bills Paid','Net Owed','Cash from Bag','Discrepancy'],
        [today,store,(tender-tax).toFixed(2),sumV().toFixed(2),((tender-tax)-sumV()).toFixed(2),
         (parseFloat(document.getElementById('dd-change').value)||0).toFixed(2),
         ((parseFloat(document.getElementById('dd-change').value)||0)-((tender-tax)-sumV())).toFixed(2)]
      ];
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(ws_data),'Deposit');
      XLSX.writeFile(wb, `${today} - ${store} Daily Deposit.xlsx`);
    }
  </script>
</body>
</html>
