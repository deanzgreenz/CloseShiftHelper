<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Close Shift & Daily Deposit Helper</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: auto; }
    h1, h2, h3 { margin: .5em 0; }
    .tabs { display: flex; margin-bottom: 20px; }
    .tab {
      padding: 8px 16px; cursor: pointer;
      border: 1px solid #ccc; background: #f0f0f0;
      margin-right: 4px; border-bottom: none; /* For better active tab look */
      border-radius: 4px 4px 0 0;
    }
    .tab.active { background: #fff; font-weight: bold; border-bottom: 1px solid #fff; position: relative; top: 1px;}
    .panel { border: 1px solid #ccc; padding: 20px; display: none; border-radius: 0 4px 4px 4px; }
    .panel.active { display: block; }
    label { display: block; margin: .5em 0 0.2em; font-weight: bold; }
    input, textarea { width: 100%; box-sizing: border-box; padding: 8px; margin-bottom: 8px; border: 1px solid #ccc; border-radius: 4px; }
    input[type="number"] { text-align: right; }
    table { width: 100%; border-collapse: collapse; margin: 1em 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f9f9f9; }
    .small-input { width: 100px; display: inline-block; padding: 6px; }
    .actions { margin-top: 20px; text-align: right; }
    .actions button { padding: 10px 16px; margin-left: 8px; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 4px; font-size: 1em; }
    .actions button:hover { background-color: #0056b3; }
    em { color: #555; font-size: .9em; font-style: italic; display: block; margin-top: -4px; margin-bottom: 8px; }
    .summary-line, .results-line { margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .summary-line strong, .results-line strong { flex-basis: 60%; text-align: left; }
    .summary-line span { flex-basis: 35%; text-align: right; font-weight: bold; background-color: #f0f0f0; padding: 4px 6px; border-radius: 3px;}
    .results-line span { flex-basis: 35%; text-align: right; font-weight: bold; padding: 4px 6px; border-radius: 3px; }
    .vendor-row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center;}
    .vendor-row input.vendor-desc { flex-grow: 1; }
    .vendor-row input.vendor-amount { width: 120px; flex-shrink: 0; }
    .shift-coin-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
    .shift-coin-row label { width: 60px; margin: 0; font-weight: normal; text-align: right; }
    .shift-coin-row input { width: 100px; margin: 0; }
    #preview { background:#f9f9f9; padding:15px; border: 1px solid #eee; border-radius: 4px; white-space: pre-wrap; font-family: monospace; max-height: 300px; overflow-y: auto; margin-top: 10px;}
    .data-missing-warning { background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 15px; margin-bottom: 20px; border-radius: 4px; display: none; } /* Initially hidden */
    .data-missing-warning p { margin: 0 0 10px 0; }
    .data-missing-warning ul { margin: 0; padding-left: 20px; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <h1>Close Shift & Daily Deposit Helper</h1>

  <div class="tabs">
    <div class="tab active" data-target="close-shift">Close Shift</div>
    <div class="tab" data-target="daily-deposit">Complete Daily Deposit</div>
  </div>

  <div id="close-shift" class="panel active">
    <h2>Close Shift</h2>
    <label for="bills">Bills (After <span class="math-inline">480 removed for Reset Till\)\:</label\>
<input id\="bills" type\="number" step\="0\.01" value\="0"\>
<h3\>Till Flipper</h3\>
<table\>
<thead\>
<tr\><th\>Coin</th\><th\>Par \(</span>)</th><th>Counted ($)</th><th>Action</th></tr>
      </thead>
      <tbody>
        <tr>
          <td>Quarters</td><td>$10.00</td>
          <td><input class="coin small-input" data-par="10" id="quarters" type="number" step="0.01" value="10.00"></td>
          <td id="act-quarters">OK</td>
        </tr>
        <tr>
          <td>Dimes</td><td>$5.00</td>
          <td><input class="coin small-input" data-par="5" id="dimes" type="number" step="0.01" value="5.00"></td>
          <td id="act-dimes">OK</td>
        </tr>
        <tr>
          <td>Nickels</td><td>$4.00</td>
          <td><input class="coin small-input" data-par="4" id="nickels" type="number" step="0.01" value="4.00"></td>
          <td id="act-nickels">OK</td>
        </tr>
        <tr>
          <td>Pennies</td><td>$1.00</td>
          <td><input class="coin small-input" data-par="1" id="pennies" type="number" step="0.01" value="1.00"></td>
          <td id="act-pennies">OK</td>
        </tr>
        <tr>
          <td>Dollar Coins</td><td><span class="math-inline">0\.00</td\>
<td\><input class\="coin small\-input" data\-par\="0" id\="dollarcoins" type\="number" step\="1\.00" value\="0"\></td\>
<td id\="act\-dollarcoins"\>OK</td\>
</tr\>
</tbody\>
</table\>
<div class\="summary\-line"\>
<strong\>Total Cash From Cash Counter \(</span>):</strong>
      <span id="bills-display">0.00</span>
    </div>
    <div class="summary-line">
      <strong>Total Coin Adjustment (<span class="math-inline">\)\:</strong\>
<span id\="coin\-adjustment"\>0\.00</span\>
</div\>
<em\>Write this total on the Shift Report Receipt</em\>
<div class\="summary\-line"\>
<strong\>Total Cash Drop \(</span>):</strong>
      <span id="cash-drop">0.00</span>
    </div>
     <em>Enter in POSaBIT Closing Drop field, and $500 in Left In Drawer field.</em>

    <div class="actions">
      <button id="calc-close-shift">Calculate Close Shift</button>
    </div>
  </div>

  <div id="daily-deposit" class="panel">
    <div id="data-warning" class="data-missing-warning">
        <p><strong>Important:</strong> Data from POSaBIT might be missing or incomplete.</p>
        <p>Please ensure you run the bookmarklet on one of the official POSaBIT dashboard pages:</p>
        <ul>
            <li>Sandy: <a href="https://app.posabit.com/merchant/7836/venue/3495/dashboard" target="_blank">app.posabit.com/merchant/7836/venue/3495/dashboard</a></li>
            <li>Foster: <a href="https://app.posabit.com/merchant/7836/venue/3496/dashboard" target="_blank">app.posabit.com/merchant/7836/venue/3496/dashboard</a></li>
            <li>Division: <a href="https://app.posabit.com/merchant/7836/venue/3497/dashboard" target="_blank">app.posabit.com/merchant/7836/venue/3497/dashboard</a></li>
        </ul>
        <p>If "Total Tendered" and "Total Taxes" below are <span class="math-inline">0\.00, the data was likely not pulled correctly\.</p\>
</div\>
<h2\>Complete Daily Deposit</h2\>
<label for\="emp\-name"\>Name\:</label\>
<input id\="emp\-name" placeholder\="Your name"\>
<label for\="dd\-date"\>Date\:</label\>
<input id\="dd\-date" readonly\>
<label for\="dd\-venue"\>Venue\:</label\>
<input id\="dd\-venue" readonly\>
<h3\>Vendor Payouts / Bills</h3\>
<div id\="vendor\-list"\>
<div class\="vendor\-row"\>
<input class\="vendor\-desc" type\="text" placeholder\="Description 1"\>
<input class\="vendor\-amount" type\="number" step\="0\.01" value\="0" placeholder\="Amount"\>
</div\>
<div class\="vendor\-row"\>
<input class\="vendor\-desc" type\="text" placeholder\="Description 2"\>
<input class\="vendor\-amount" type\="number" step\="0\.01" value\="0" placeholder\="Amount"\>
</div\>
<div class\="vendor\-row"\>
<input class\="vendor\-desc" type\="text" placeholder\="Description 3"\>
<input class\="vendor\-amount" type\="number" step\="0\.01" value\="0" placeholder\="Amount"\>
</div\>
<div class\="vendor\-row"\>
<input class\="vendor\-desc" type\="text" placeholder\="Description 4"\>
<input class\="vendor\-amount" type\="number" step\="0\.01" value\="0" placeholder\="Amount"\>
</div\>
<div class\="vendor\-row"\>
<input class\="vendor\-desc" type\="text" placeholder\="Description 5"\>
<input class\="vendor\-amount" type\="number" step\="0\.01" value\="0" placeholder\="Amount"\>
</div\>
</div\>
<div class\="summary\-line"\>
<strong\>Total Vendor Payouts \(</span>):</strong>
      <span id="total-vendor">0.00</span>
    </div>

    <h3>Totals</h3>
    <div class="summary-line"><strong>Total Tendered (<span class="math-inline">\)\:</strong\> <span id\="dd\-tendered"\>0\.00</span\></div\>
<div class\="summary\-line"\><strong\>Total Taxes \(</span>):</strong> <span id="dd-taxes">0.00</span></div>
    <div class="summary-line"><strong>Net from POSaBIT Sales (<span class="math-inline">\)\:</strong\> <span id\="dd\-net\-sales"\>0\.00</span\></div\>
<div class\="summary\-line"\><strong\>Net Deposit After Bills \(</span>):</strong> <span id="dd-net-after-bills">0.00</span></div>

    <h3>Cash &amp; Coins</h3>
    <div>
      <label for="closing-cash">Total Closing Cash (<span class="math-inline">\)\:</label\>
<input id\="closing\-cash" type\="number" step\="0\.01" value\="0"\>
<em\>Remaining cash after setting aside Taxes &amp; Bills</em\>
</div\>
<h4\>Shift Coin Adjustments</h4\>
<div id\="coin\-adjust\-list"\>
<div class\="shift\-coin\-row"\><label for\="shift1\-coin"\>Shift 1\:</label\> <input id\="shift1\-coin" class\="shift\-coin" type\="number" step\="0\.01" value\="0"\></div\>
<div class\="shift\-coin\-row"\><label for\="shift2\-coin"\>Shift 2\:</label\> <input id\="shift2\-coin" class\="shift\-coin" type\="number" step\="0\.01" value\="0"\></div\>
<div class\="shift\-coin\-row"\><label for\="shift3\-coin"\>Shift 3\:</label\> <input id\="shift3\-coin" class\="shift\-coin" type\="number" step\="0\.01" value\="0"\></div\>
<div class\="shift\-coin\-row"\><label for\="shift4\-coin"\>Shift 4\:</label\> <input id\="shift4\-coin" class\="shift\-coin" type\="number" step\="0\.01" value\="0"\></div\>
<div class\="shift\-coin\-row"\><label for\="shift5\-coin"\>Shift 5\:</label\> <input id\="shift5\-coin" class\="shift\-coin" type\="number" step\="0\.01" value\="0"\></div\>
<div class\="shift\-coin\-row"\><label for\="shift6\-coin"\>Shift 6\:</label\> <input id\="shift6\-coin" class\="shift\-coin" type\="number" step\="0\.01" value\="0"\></div\>
</div\>
<div class\="summary\-line"\><strong\>Total Closing Coin Adjustments \(</span>):</strong> <span id="total-coin-adjust-shifts">0.00</span></div>
     <div class="summary-line"><strong>Total Cash &amp; Coins (<span class="math-inline">\)\:</strong\> <span id\="total\-cash\-coins"\>0\.00</span\></div\>
<h3\>Results</h3\>
<div class\="results\-line"\><strong\>Actual Deposit \(</span>):</strong> <span id="res-actual">0.00</span></div>
    <div class="results-line"><strong>Net Deposit (<span class="math-inline">\)\:</strong\> <span id\="res\-net\-deposit"\>0\.00</span\></div\>
<div class\="results\-line"\><strong\>Difference \(</span>):</strong> <span id="res-difference">0.00</span></div>

    <label for="change-bag">Money from Change Bag ($):</label>
    <input id="change-bag" type="number" step="0.01" value="0">

    <label for="notes">Notes:</label>
    <textarea id="notes" rows="3"></textarea>

    <h3>Preview</h3>
    <pre id="preview"></pre>

    <div class="actions">
      <button id="calc-daily-deposit">Calculate & Preview Deposit</button>
      <button id="export-excel">Save Daily Deposit Sheet</button>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', ()=>{
    const round = (num) => Math.round((num + Number.EPSILON) * 100) / 100;

    document.querySelectorAll('.tab').forEach(t=>{
      t.onclick=()=>{
        document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        t.classList.add('active');
        const targetPanel = document.getElementById(t.dataset.target);
        targetPanel.classList.add('active');
        // After switching tab, re-evaluate focusable elements for Enter key navigation
        setupEnterKeyNavigation(targetPanel);
      };
    });

    const params = new URLSearchParams(location.search);
    const tendered = +params.get('tendered') || 0;
    const taxes = +params.get('tax') || 0;
    const store = params.get('store') || 'Unknown Venue';

    const ddTenderedDisplay = document.getElementById('dd-tendered');
    const ddTaxesDisplay = document.getElementById('dd-taxes');
    const dataWarningDiv = document.getElementById('data-warning');

    ddTenderedDisplay.textContent = tendered.toFixed(2);
    ddTaxesDisplay.textContent = taxes.toFixed(2);

    // --- Check for missing POSaBIT data ---
    function checkAndShowWarning() {
      if (tendered === 0 && taxes === 0 && store === 'Unknown Venue') {
        dataWarningDiv.style.display = 'block';
      } else {
        dataWarningDiv.style.display = 'none'; // Ensure it's hidden if data is present
      }
    }

    checkAndShowWarning(); // Call on page load

    // --- Close Shift Tab Logic ---
    const billsInput = document.getElementById('bills');
    const billsDisplay = document.getElementById('bills-display');
    const coinAdjustment