<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Daily Deposit Tool</title>
<style>
  :root {
    --bg: #0f1219;
    --card: #171b26;
    --border: #242c3f;
    --ink: #e9edf3;
    --sub: #a6b3ca;
    --muted: #93a4c4;
    --input-bg: #0c111a;
    --input-border: #2a3347;
    --ok: #22c55e;
    --bad: #ef4444;
    --info: #3b82f6;
  }

  * { box-sizing: border-box; }
  
  body {
    margin: 0;
    font-family: Inter, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    background: var(--bg);
    color: var(--ink);
    line-height: 1.5;
  }

  .container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }

  h1 {
    margin: 0 0 24px 0;
    font-size: 28px;
    font-weight: 700;
  }

  h2 {
    margin: 0 0 16px 0;
    font-size: 18px;
    font-weight: 600;
    color: var(--ink);
  }

  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
  }

  .grid {
    display: grid;
    gap: 20px;
    margin-bottom: 20px;
  }

  .grid-2 {
    grid-template-columns: 1fr 1fr;
  }

  @media (max-width: 768px) {
    .grid-2 {
      grid-template-columns: 1fr;
    }
  }

  .row {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    align-items: center;
    margin-bottom: 12px;
  }

  .col {
    flex: 1 1 200px;
  }

  label {
    display: block;
    font-size: 13px;
    color: var(--sub);
    margin-bottom: 6px;
    font-weight: 500;
  }

  input, select, textarea {
    width: 100%;
    padding: 10px 12px;
    background: var(--input-bg);
    color: var(--ink);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    font-size: 14px;
    transition: border-color 0.2s;
  }

  input:focus, select:focus {
    outline: none;
    border-color: var(--info);
  }

  input[type="checkbox"] {
    width: auto;
    margin-right: 8px;
  }

  button {
    padding: 10px 16px;
    background: var(--ok);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    font-size: 14px;
    transition: opacity 0.2s;
  }

  button:hover {
    opacity: 0.9;
  }

  button.secondary {
    background: #1f2937;
  }

  button.small {
    padding: 6px 12px;
    font-size: 12px;
  }

  button.danger {
    background: var(--bad);
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }

  th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }

  th {
    color: var(--sub);
    font-weight: 600;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .text-right {
    text-align: right;
  }

  .text-center {
    text-align: center;
  }

  .mono {
    font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
  }

  .summary-box {
    background: var(--input-bg);
    border: 1px solid var(--input-border);
    border-radius: 8px;
    padding: 16px;
    margin-top: 20px;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
  }

  .summary-row:last-child {
    border-bottom: none;
    padding-top: 12px;
    font-weight: 600;
    font-size: 16px;
  }

  .pill {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 700;
    margin-left: 8px;
  }

  .ok {
    background: #03261b;
    color: #86efac;
    border: 1px solid #14532d;
  }

  .bad {
    background: #2a0e0e;
    color: #fca5a5;
    border: 1px solid #7f1d1d;
  }

  .help-text {
    font-size: 12px;
    color: var(--muted);
    margin-top: 4px;
  }

  .sticky-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(15, 18, 25, 0.95);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--border);
    padding: 16px 0;
    margin: -20px -20px 20px -20px;
  }

  .header-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    max-width: 1000px;
    margin: 0 auto;
    padding: 0 20px;
  }

  .stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px;
  }

  .stat-label {
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
  }

  .stat-value {
    font-size: 20px;
    font-weight: 700;
    color: var(--ink);
  }

  #pasteCatcher {
    position: absolute;
    left: -9999px;
    top: -9999px;
    width: 1px;
    height: 1px;
    opacity: 0;
  }

  @media print {
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --border: #dddddd;
      --ink: #000000;
      --sub: #555555;
      --muted: #777777;
    }
    body {
      background: white;
      color: black;
      font-size: 12px;
    }
    .container {
      padding: 0;
      max-width: 100%;
    }
    .sticky-header, button, .help-text, .danger, #btnPaste {
      display: none !important;
    }
    .card {
      border: 1px solid #ccc;
      page-break-inside: avoid;
      box-shadow: none;
    }
    h1, h2, h3, h4 {
      color: #000;
    }
    input, select {
      border: 1px solid #ccc !important;
      background: #f9f9f9 !important;
      color: #000 !important;
    }
    .summary-box {
      border: 1px solid #ccc;
    }
    .summary-row {
      border-bottom: 1px solid #ccc;
    }
    th, td {
      border-bottom: 1px solid #ccc;
    }
  }
</style>
</head>
<body>

<div class="sticky-header">
  <div class="header-stats">
    <div class="stat-card">
      <div class="stat-label">Store</div>
      <div class="stat-value" id="header-store">—</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Actual Final Deposit</div>
      <div class="stat-value mono" id="header-actual">$0.00</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Expected Final Deposit</div>
      <div class="stat-value mono" id="header-expected">$0.00</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Difference</div>
      <div class="stat-value mono" id="header-diff">$0.00</div>
      <span id="header-status" class="pill ok">OK</span>
    </div>
  </div>
</div>

<div class="container">
  <h1>DG Daily Deposit Tool</h1>

  <div class="card">
    <h2>1) POS Totals</h2>
    <div class="row">
      <div class="col">
        <label>Store</label>
        <select id="store">
          <option value="">Select...</option>
          <option>Sandy</option>
          <option>Foster</option>
          <option>Division</option>
        </select>
      </div>
      <div class="col">
        <label>Date</label>
        <input type="date" id="bizDate" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Cash Total (Tendered)</label>
        <input type="number" id="cashTotal" step="0.01" placeholder="0.00" />
      </div>
      <div class="col">
        <label>Debit Total (Tendered)</label>
        <input type="number" id="debitTotal" step="0.01" placeholder="0.00" />
      </div>
    </div>
    <div class="row">
      <div class="col">
        <label>Cashback Given</label>
        <input type="number" id="cashbackTotal" step="0.01" placeholder="0.00" />
        <div class="help-text">Enter as a positive number, e.g. 27.70</div>
      </div>
      <div class="col">
        <label>Taxes (Collected)</label>
        <input type="number" id="taxTotal" step="0.01" placeholder="0.00" />
      </div>
    </div>
    <div class="row">
      <button id="btnPaste" class="secondary">Paste from Clipboard</button>
    </div>
    <div class="help-text">Tip: On the POSaBIT Dashboard: Ctrl+A, Ctrl+C, then click this. If your browser blocks clipboard, just press Ctrl+V anywhere on this page.</div>
    <textarea id="pasteCatcher" aria-hidden="true" tabindex="-1"></textarea>
  </div>

  <div class="grid grid-2">
    <div class="card">
      <h2>2) Bills (Set Aside)</h2>
      <div class="help-text" style="margin-bottom: 12px;">e.g. Rent. Set aside from final cash. Defaults appear when you choose a store.</div>
      <table id="billsTable">
        <thead>
          <tr>
            <th>Description</th>
            <th class="text-right">Amount</th>
            <th class="text-center">—</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td class="text-right"><strong>Total Bills</strong></td>
            <td class="text-right mono"><strong id="billsSum">$0.00</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      <div class="row" style="margin-top: 12px;">
        <button class="secondary small" id="addBill">Add bill</button>
        <button class="secondary small" id="applyDefaults">Re-apply defaults</button>
      </div>
    </div>

    <div class="card">
      <h2>3) Vendor Payouts (From Register)</h2>
      <div class="help-text" style="margin-bottom: 12px;">e.g. Keys, supplies. Paid from a till during a shift. Reduces expected cash.</div>
      <table id="payoutsTable">
        <thead>
          <tr>
            <th>Description</th>
            <th class="text-right">Amount</th>
            <th class="text-center">—</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td class="text-right"><strong>Total Payouts</strong></td>
            <td class="text-right mono"><strong id="payoutsSum">$0.00</strong></td>
            <td></td>
          </tr>
        </tfoot>
      </table>
       <div class="row" style="margin-top: 12px;">
        <button class="secondary small" id="addPayout">Add payout</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>4) Shifts</h2>
    <table id="shiftTable">
      <thead>
        <tr>
          <th style="width: 50px;">#</th>
          <th>Employee / Notes</th>
          <th class="text-right">Shift Cash Drop (bills)</th>
          <th class="text-right">Shift Coin ±</th>
          <th class="text-center">—</th>
        </tr>
      </thead>
      <tbody></tbody>
      <tfoot>
        <tr>
          <td></td>
          <td class="text-right"><strong>Total Physical Cash</strong></td>
          <td class="text-right mono"><strong id="dropSum">$0.00</strong></td>
          <td class="text-right mono"><strong id="coinSum">$0.00</strong></td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    <div class="row" style="margin-top: 12px;">
      <button class="secondary small" id="addShift">Add shift</button>
      <button class="danger small" id="clearShifts">Clear</button>
    </div>
  </div>

  <div class="card">
    <h2>5) Results</h2>
    <div class="summary-box">
      <div class="summary-row">
        <span>Physical Cash Counted (Gross)</span>
        <span class="mono" id="grossCash">$0.00</span>
      </div>
      <div class="summary-row">
        <span>Expected Cash in Till (Gross)</span>
        <span class="mono" id="expectedGrossCash">$0.00</span>
      </div>
       <hr style="border-color: var(--border); margin: 8px 0;">
      <div class="summary-row">
        <span>Actual Final Deposit (after bills)</span>
        <span class="mono"><strong id="actual">$0.00</strong></span>
      </div>
      <div class="summary-row">
        <span>Expected Final Deposit (after bills)</span>
        <span class="mono"><strong id="expected">$0.00</strong></span>
      </div>
      <div class="summary-row">
        <span><strong>Difference (Over/Short)</strong></span>
        <span>
          <strong class="mono" id="diff">$0.00</strong>
          <span id="diffStatus" class="pill ok">OK</span>
        </span>
      </div>
    </div>
    <div class="row" style="margin-top: 20px;">
      <button id="exportBtn">Export (.xlsx)</button>
      <button class="secondary" id="printBtn">Print / Save PDF</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // Utility functions
  const $ = s => document.querySelector(s);
  const fmt = n => (isFinite(n)?n:0).toLocaleString(undefined,{style:'currency',currency:'USD'});
  const num = v => { 
    if(typeof v==='number') return v; 
    const s=(''+(v||'')).replace(/[^0-9.\-]/g,''); 
    const n=parseFloat(s); 
    return isFinite(n)?n:0; 
  };
  const r2 = n => Math.round((n+Number.EPSILON)*100)/100;

  // Store defaults
  const DEFAULTS = {
    "Sandy":[["Sandy Rent",350],["Sandy Bills",200]],
    "Foster":[["Foster Rent",350],["Foster Bills",150]],
    "Division":[["Division Rent",350],["Division Bills",150]],
  };
  
  // Set today's date
  const d=new Date();
  const pad=x=>x.toString().padStart(2,'0');
  $('#bizDate').value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  const billsBody = $('#billsTable tbody');
  const payoutsBody = $('#payoutsTable tbody');
  const shiftsBody = $('#shiftTable tbody');

  // --- BOOKMARKLET/URL PARAMETER HANDLING ---
  const p = new URLSearchParams(location.search);
  const setFromParam = (selector, key) => {
      const v = p.get(key);
      if (v != null) {
          const el = $(selector);
          if (el) el.value = v;
      }
  };
  
  const storeParam = p.get('store');
  if (storeParam) {
      const storeSelect = $('#store');
      if (storeSelect) storeSelect.value = storeParam;
  }
  setFromParam('#cashTotal', 'cashTotal');
  setFromParam('#debitTotal', 'debitTotal');
  setFromParam('#cashbackTotal', 'cashbackTotal');
  setFromParam('#taxTotal', 'tax');


  // Main recalculation function
  function recalc(){
    // 1. Get all input values
    const cash = num($('#cashTotal').value);
    const cashback = Math.abs(num($('#cashbackTotal').value));
    
    const bills = Array.from(billsBody.querySelectorAll('input.pamt')).reduce((a,el)=>a+num(el.value),0);
    const payouts = Array.from(payoutsBody.querySelectorAll('input.pamt')).reduce((a,el)=>a+num(el.value),0);
    
    const drop = Array.from(shiftsBody.querySelectorAll('td:nth-child(3) input')).reduce((a,el)=>a+num(el.value),0);
    const coin = Array.from(shiftsBody.querySelectorAll('td:nth-child(4) input')).reduce((a,el)=>a+num(el.value),0);
    const actual_gross_cash = r2(drop + coin);

    // 2. --- CORE LOGIC ---
    // Expected cash in till = POS cash total, minus cash given back, minus payouts made from the till.
    const expected_gross_cash = r2(cash - cashback - payouts);
    
    // The Difference is the discrepancy between what was counted and what was expected in the till.
    const diff = r2(actual_gross_cash - expected_gross_cash);
    
    // The final deposit is the counted cash, minus the bills set aside from it.
    const actual_final_deposit = r2(actual_gross_cash - bills);
    
    // The expected deposit is what the books say it should be after all deductions.
    const expected_final_deposit = r2(expected_gross_cash - bills);

    // 3. --- UPDATE UI ---
    $('#billsSum').textContent = fmt(bills);
    $('#payoutsSum').textContent = fmt(payouts);
    $('#dropSum').textContent = fmt(drop);
    $('#coinSum').textContent = fmt(coin);

    $('#grossCash').textContent = fmt(actual_gross_cash);
    $('#expectedGrossCash').textContent = fmt(expected_gross_cash);
    $('#actual').textContent = fmt(actual_final_deposit);
    $('#expected').textContent = fmt(expected_final_deposit);
    $('#diff').textContent = fmt(diff);

    $('#header-store').textContent = $('#store').value || '—';
    $('#header-actual').textContent = fmt(actual_final_deposit);
    $('#header-expected').textContent = fmt(expected_final_deposit);
    $('#header-diff').textContent = fmt(diff);
    
    const abs = Math.abs(diff);
    const status = abs < 1.00 ? 'OK' : (diff>0 ? 'OVER' : 'SHORT');
    const statusClass = abs < 1.00 ? 'pill ok' : 'pill bad';
    
    $('#diffStatus').textContent = status;
    $('#diffStatus').className = statusClass;
    $('#header-status').textContent = status;
    $('#header-status').className = statusClass;
  }

  // Generic function to add a row to a table
  function addPaymentRow(tbody, desc='', amount=''){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="pdesc" placeholder="Description" value="${desc}"></td>
      <td class="text-right"><input class="pamt" type="number" step="0.01" placeholder="0.00" value="${amount}"></td>
      <td class="text-center"><button class="danger small" type="button">X</button></td>`;
    tr.querySelector('button').addEventListener('click', ()=>{ tr.remove(); recalc(); });
    tbody.appendChild(tr);
  }

  function applyStoreDefaults(){
    const store = $('#store').value;
    billsBody.innerHTML = '';
    (DEFAULTS[store]||[]).forEach(([d,a])=> addPaymentRow(billsBody, d, a));
    recalc();
  }

  function addShiftRow(note='', drop='', coin=''){
    const idx = shiftsBody.children.length + 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${idx}</td>
      <td><input placeholder="Name / notes" value="${note}"/></td>
      <td class="text-right"><input type="number" step="0.01" placeholder="0.00" value="${drop}"/></td>
      <td class="text-right"><input type="number" step="0.01" placeholder="0.00" value="${coin}"/></td>
      <td class="text-center"><button class="danger small" type="button">X</button></td>`;
    tr.querySelector('button').addEventListener('click', ()=>{ 
      tr.remove(); 
      Array.from(shiftsBody.children).forEach((r,i)=> r.firstElementChild.textContent = (i+1)); 
      recalc(); 
    });
    shiftsBody.appendChild(tr);
  }

  // Initial setup
  for(let i=0;i<3;i++) addShiftRow();
  addPaymentRow(payoutsBody);

  // Wire up buttons
  $('#addBill').addEventListener('click', () => addPaymentRow(billsBody));
  $('#addPayout').addEventListener('click', () => addPaymentRow(payoutsBody));
  $('#applyDefaults').addEventListener('click', applyStoreDefaults);
  $('#addShift').addEventListener('click', () => addShiftRow());
  $('#clearShifts').addEventListener('click', ()=>{ shiftsBody.innerHTML=''; recalc(); });
  $('#store').addEventListener('change', applyStoreDefaults);
  document.addEventListener('input', e => { if(e.target.matches('input,select')) recalc(); });
  $('#printBtn').addEventListener('click', () => window.print());

  function parseDashboard(text) {
    if (!text) return false;
    text = text.replace(/\u00a0/g, ' ').replace(/\r/g, '');
    const asDollars = s => {
      if (!s) return 0;
      const match = String(s).match(/-?\$?[\d,]+\.\d{2}/);
      return match ? parseFloat(match[0].replace(/[^0-9.\-]/g, '')) : 0;
    };

    const storeMatch = text.match(/Deanz Greenz\s*-\s*(Sandy|Foster|Division)/i);
    if (storeMatch) {
      $('#store').value = storeMatch[1];
      applyStoreDefaults();
    }

    let cashTotal = 0, debitTotal = 0, cashbackTotal = 0, taxTotal = 0;
    const paymentMethodSectionMatch = text.match(/Payment Method([\s\S]*?)(?:TaxApplicable|$)/i);
    if (paymentMethodSectionMatch) {
      const segments = paymentMethodSectionMatch[1].split(/(?=Cash\b|Debit Card\b|Debit\b|Cashless ATM\b|Cashback\b|Total\b)/gi);
      segments.forEach(segment => {
        const amounts = segment.match(/-?\$[\d,]+\.\d{2}/g);
        if (!amounts) return;
        const lastAmount = amounts[amounts.length - 1];
        if (/^cash(?!back)/i.test(segment)) cashTotal = asDollars(lastAmount);
        else if (/^cashback/i.test(segment)) cashbackTotal = asDollars(lastAmount);
        else if (/^debit/i.test(segment)) debitTotal = asDollars(lastAmount);
      });
    }

    const taxLineMatch = text.match(/Oregon State Marijuana Tax - 20%[^\$]*\$[\d,.-]+[^\$]*(\$[\d,.-]+)/i);
    if (taxLineMatch) taxTotal = asDollars(taxLineMatch[1]);

    const updateField = (selector, value, makeAbs = false) => {
        const field = $(selector);
        if (field) {
            let finalValue = makeAbs ? Math.abs(value) : value;
            field.value = finalValue.toFixed(2);
        }
    };
    updateField('#cashTotal', cashTotal);
    updateField('#debitTotal', debitTotal);
    updateField('#cashbackTotal', cashbackTotal, true);
    updateField('#taxTotal', taxTotal);
    recalc();
    return true;
  }

  // --- Paste Functionality with Fallback ---
  $('#btnPaste').addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      const txt = await navigator.clipboard.readText();
      if (txt && parseDashboard(txt)) return;
    } catch (err) {
      console.warn("Clipboard API failed, falling back to paste event.", err);
    }
    
    // Fallback for browsers that block clipboard API
    const cat = $('#pasteCatcher');
    cat.value=''; cat.style.left='0'; cat.style.top='0'; cat.focus();
    alert('Clipboard blocked or failed. Please press Ctrl+V (or ⌘V) now.');
  });

  document.addEventListener('paste', (e) => {
    const data = (e.clipboardData || window.clipboardData)?.getData('text');
    if(data && data.length > 50){ 
      e.preventDefault(); 
      parseDashboard(data); 
      const cat = $('#pasteCatcher');
      cat.blur(); cat.style.left='-9999px'; cat.style.top='-9999px';
    }
  });

  // --- Export Functionality ---
  $('#exportBtn').addEventListener('click', () => {
    if (typeof XLSX === 'undefined') {
      alert("XLSX library is not loaded. Cannot export to .xlsx");
      return;
    }

    const store = $('#store').value || 'Unknown';
    const dt = $('#bizDate').value || '';
    
    const data = [
        ['----- Daily Deposit Summary -----', ''],
        ['Store', store],
        ['Date', dt],
        ['', ''],
        ['----- POS Totals -----', ''],
        ['Cash Total (Tendered)', num($('#cashTotal').value)],
        ['Debit Total (Tendered)', num($('#debitTotal').value)],
        ['Cashback Given', num($('#cashbackTotal').value)],
        ['Taxes (Collected)', num($('#taxTotal').value)],
        ['', ''],
        ['----- Bills (Set Aside) -----', '']
    ];
    
    Array.from(billsBody.querySelectorAll('tr')).forEach(tr => {
        const desc = tr.querySelector('input.pdesc')?.value || '(No Description)';
        const amt = num(tr.querySelector('input.pamt')?.value);
        data.push([`  ${desc}`, amt]);
    });
    data.push(['Total Bills', num($('#billsSum').textContent)]);
    data.push(['', '']);
    
    data.push(['----- Vendor Payouts (From Register) -----', '']);
    Array.from(payoutsBody.querySelectorAll('tr')).forEach(tr => {
        const desc = tr.querySelector('input.pdesc')?.value || '(No Description)';
        const amt = num(tr.querySelector('input.pamt')?.value);
        data.push([`  ${desc}`, amt]);
    });
    data.push(['Total Payouts', num($('#payoutsSum').textContent)]);
    data.push(['', '']);

    data.push(['----- Shifts -----', '']);
    Array.from(shiftsBody.querySelectorAll('tr')).forEach((tr, i) => {
        const notes = tr.querySelector('td:nth-child(2) input')?.value || '';
        const drop = num(tr.querySelector('td:nth-child(3) input')?.value);
        const coin = num(tr.querySelector('td:nth-child(4) input')?.value);
        data.push([`Shift ${i+1}: ${notes}`, `Drop: ${fmt(drop)}`, `Coin: ${fmt(coin)}`]);
    });
    data.push(['Total Physical Cash', num($('#grossCash').textContent)]);
    data.push(['', '']);

    data.push(['----- Results -----', '']);
    data.push(['Physical Cash Counted (Gross)', num($('#grossCash').textContent)]);
    data.push(['Expected Cash in Till (Gross)', num($('#expectedGrossCash').textContent)]);
    data.push(['Actual Final Deposit (after bills)', num($('#actual').textContent)]);
    data.push(['Expected Final Deposit (after bills)', num($('#expected').textContent)]);
    data.push(['Difference (Over/Short)', num($('#diff').textContent)]);

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(data);
    
    // Formatting
    ws['!cols'] = [{ wch: 35 }, { wch: 15 }, { wch: 15 }];
    Object.keys(ws).forEach(cellRef => {
        if (cellRef[0] === '!') return;
        const cell = ws[cellRef];
        const col = XLSX.utils.decode_cell(cellRef).c;
        if (col > 0 && cell.t === 'n') {
            cell.z = '$#,##0.00';
        }
        if(cell.v.toString().startsWith('-----')){
            cell.s = { font: { bold: true } };
        }
    });

    XLSX.utils.book_append_sheet(wb, ws, 'Daily Deposit');
    const fname = `DG-Deposit_${store}_${dt||'date'}.xlsx`.replace(/\s+/g,'-');
    XLSX.writeFile(wb, fname);
  });

  // Final setup calls
  applyStoreDefaults();
  recalc();
});
</script>

<!-- Include XLSX library for Excel export -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

</body>
</html>
