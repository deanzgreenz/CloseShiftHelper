<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DG Tools — Daily Deposit (Simple v3.3, Excel Export)</title>
<style>
  :root{
    --bg:#0f1219; --card:#171b26; --muted:#21293a; --ink:#e9edf3; --sub:#a6b3ca;
    --ok:#12b981; --bad:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
       background:var(--bg); color:var(--ink); line-height:1.45}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  h1,h2{margin:.2rem 0 .6rem}
  .card{background:var(--card); border:1px solid #242c3f; border-radius:12px; padding:12px}
  .grid{display:grid; gap:12px}
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .col{flex:1 1 200px}
  label{display:block; font-size:12px; color:#a6b3ca; margin-bottom:6px}
  input, select{width:100%; padding:10px 12px; background:#0c111a; color:#e9edf3;
    border:1px solid #2a3347; border-radius:10px;}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{padding:8px 10px; border-bottom:1px solid #242c3f}
  th{text-align:left; color:#b8c3d8}
  .right{text-align:right} .center{text-align:center}
  .btn{background:#22c55e; color:white; border:none; border-radius:10px; padding:10px 12px; font-weight:600; cursor:pointer}
  .btn.sub{background:#1f2937}
  .pill{display:inline-block; padding:6px 10px; border-radius:999px; font-weight:700}
  .ok{background:#03261b;color:#86efac;border:1px solid #14532d}
  .bad{background:#2a0e0e;color:#fca5a5;border:1px solid #7f1d1d}
  .sticky{position:sticky; top:0; z-index:20; backdrop-filter:blur(8px);
          background:rgba(15,18,25,.9); border-bottom:1px solid #1b2333}
  .mono{font-family: ui-monospace, Menlo, Consolas, monospace}
  .help{font-size:11px; color:#93a4c4}

@media print {
  * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  body { background: #fff !important; color: #000 !important; }
  .wrap { padding: 0 !important; }
  .card { background: #fff !important; border-color: #000 !important; }
  .sticky { position: static !important; background: #fff !important; border:none !important; }
  .btn, .help { display: none !important; }
  table th, table td { border-color: #000 !important; }
}

</style>
</head>
<body>
<div class="sticky">
  <div class="wrap grid" style="grid-template-columns: 1fr 1fr 1fr 1fr;">
    <div class="card">
      <div style="font-size:12px;letter-spacing:.12em;color:#93c5fd;text-transform:uppercase">Store</div>
      <div id="sumStore" style="font-weight:800">—</div>
      <div class="help" id="sumDate"></div>
    </div>
    <div class="card">
      <div class="help" id="sumActualLabel">Actual Deposit</div>
      <div id="sumActual" class="mono" style="font-size:18px;font-weight:800">$0.00</div>
      <div class="help" id="sumActualFormula">= Σ Drop + Σ Coin ±</div>
    </div>
    <div class="card">
      <div class="help">POS Net After Bills</div>
      <div id="sumExpected" class="mono" style="font-size:18px;font-weight:800">$0.00</div>
      <div class="help">= (Cash + Debit − Cashback − Taxes) − Σ Payouts</div>
    </div>
    <div class="card">
      <div class="help">Difference</div>
      <div id="sumDiff" class="mono" style="font-size:18px;font-weight:800">$0.00</div>
      <div id="sumStatus" class="pill ok" style="margin-top:6px">OK</div>
    </div>
  </div>
</div>

<div class="wrap">
  <h1>DG Tools — Daily Deposit</h1>
  <div class="grid" style="grid-template-columns:1fr 1fr;">
    <section class="card">
      <h2>1) POS Totals</h2>
      <div class="row">
        <div class="col">
          <label>Store</label>
          <select id="store">
            <option value="">Select…</option>
            <option>Sandy</option>
            <option>Foster</option>
            <option>Division</option>
          </select>
        </div>
        <div class="col"><label>Date</label><input id="bizDate" type="date"></div>
      </div>
      <div class="row">
        <div class="col"><label>Cash Total</label><input id="cashTotal" inputmode="decimal" placeholder="0.00"></div>
        <div class="col"><label>Debit Total</label><input id="debitTotal" inputmode="decimal" placeholder="0.00"></div>
      </div>
      <div class="row">
        <div class="col"><label>Cashback Given</label><input id="cashbackTotal" inputmode="decimal" placeholder="0.00"></div>
        <div class="col"><label>Taxes</label><input id="taxTotal" inputmode="decimal" placeholder="0.00"></div>
      </div>
      <div class="row">
        <button id="btnPaste" class="btn sub">Paste from Clipboard</button>
        <div class="help">Tip: On the POSaBIT Venue Dashboard: Ctrl+A, Ctrl+C, then click this.</div>
      </div>
    </section>

    <section class="card">
      <h2>2) Vendor Payouts / Bills</h2>
      <div class="help">Defaults appear when you choose a store. Add rows for extras.</div>
      <table id="payoutTable">
        <thead>
          <tr><th>Description</th><th class="right">Amount</th><th class="center">—</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td class="right">Total Payouts</td><td class="right mono" id="payoutSum">$0.00</td><td></td></tr>
        </tfoot>
      </table>
      <div class="row">
        <button class="btn sub" id="addPayout">Add payout</button>
        <button class="btn sub" id="applyDefaults">Re-apply store defaults</button>
        <button class="btn sub" id="clearPayouts">Clear</button>
      </div>
    </section>
  </div>

  <section class="card">
    <h2>3) Shifts</h2>
    <table id="shiftTable">
      <thead><tr><th>#</th><th>Employee / Notes</th><th class="right">Shift Cash Drop (bills)</th><th class="right">Shift Coin ±</th><th class="center">—</th></tr></thead>
      <tbody></tbody>
      <tfoot><tr><td></td><td class="right">Totals</td><td class="right mono" id="dropSum">$0.00</td><td class="right mono" id="coinSum">$0.00</td><td></td></tr></tfoot>
    </table>
    <div class="row" style="margin-top:10px">
      <button class="btn sub" id="addShift">Add shift</button>
      <button class="btn sub" id="clearShifts">Clear</button>
    </div>
  </section>

  <section class="card">
    <h2>Change Bag (Note Only)</h2>
    <div class="row">
      <div class="col"><label>Change Bag Amount</label><input id="changeBag" inputmode="decimal" placeholder="0.00"></div>
      <div class="col"><label>Note</label><input id="changeNote" placeholder="Describe (not used in math)"></div>
    </div>
    <div class="help">For record-keeping only. Not included in any calculations.</div>
  </section>

  <section class="card">
    <h2>4) Results</h2>
    <div class="row" style="margin:8px 0 4px 0">
      <label style="display:flex; gap:8px; align-items:center; font-weight:600;">
        <input type="checkbox" id="enterGross" checked>
        Enter shift drops <b>BEFORE</b> taxes &amp; payouts are pulled
      </label>
    </div>
    <div class="help" id="grossNote">In this mode, the tool auto‑subtracts Taxes and Vendor Payouts from the deposit.</div>

    <table>
      <tbody>
        <tr><td id="actualLabel">Actual Deposit (Σ Drop + Σ Coin ±)</td><td class="right mono" id="actual">$0.00</td></tr>
        <tr id="grossRow" style="display:none;"><td>Gross Closing Cash (Σ Drop + Σ Coin ±)</td><td class="right mono" id="grossCash">$0.00</td></tr>
        <tr><td>POS Net After Bills ((Cash + Debit − Cashback − Taxes) − Σ Payouts)</td><td class="right mono" id="expected">$0.00</td></tr>
        <tr><td><b>Difference (Actual − POS Net)</b></td><td class="right mono" id="diff">$0.00</td></tr>
      </tbody>
    </table>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="exportBtn">Export (.xlsx if available, else .csv)</button>
      <button class="btn sub" id="printBtn">Print / Save PDF</button>
    </div>
    <div class="help">To enable .xlsx, include SheetJS on the page. See commented script tag at the bottom.</div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const $ = s => document.querySelector(s), $$ = s => Array.from(document.querySelectorAll(s));
  const fmt = n => (isFinite(n)?n:0).toLocaleString(undefined,{style:'currency',currency:'USD'});
  const num = v => { if(typeof v==='number') return v; const s=(''+(v||'')).replace(/[^0-9.\\-]/g,''); const n=parseFloat(s); return isFinite(n)?n:0; };
  const r2 = n => Math.round((n+Number.EPSILON)*100)/100;

  const DEFAULTS = {
    "Sandy":[["Sandy Rent",350],["Sandy Bills",200]],
    "Foster":[["Foster Rent",350],["Foster Bills",150]],
    "Division":[["Division Rent",350],["Division Bills",150]],
  };

  const p = new URLSearchParams(location.search);
  const set = (sel,key) => { const v=p.get(key); if(v!=null){ const el=$(sel); if(el) el.value=v; } };
  set('#store','store'); set('#cashTotal','cashTotal'); set('#debitTotal','debitTotal'); set('#cashbackTotal','cashbackTotal'); set('#taxTotal','tax');
  const d=new Date(), pad=x=>x.toString().padStart(2,'0');
  const bizDate = $('#bizDate'); if(bizDate) bizDate.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  const pbody = $('#payoutTable tbody');
  const sbody = $('#shiftTable tbody');

  function recalc(){
    const cash = num($('#cashTotal')?.value);
    const debit = num($('#debitTotal')?.value);
    const cashback = num($('#cashbackTotal')?.value);
    const tax = num($('#taxTotal')?.value);
    const drop = r2(Array.from(sbody?.querySelectorAll('td:nth-child(3) input')||[]).reduce((a,el)=>a+num(el.value),0));
    const coin = r2(Array.from(sbody?.querySelectorAll('td:nth-child(4) input')||[]).reduce((a,el)=>a+num(el.value),0));
    $('#dropSum').textContent = fmt(drop);
    $('#coinSum').textContent = fmt(coin);
    const payouts = r2(Array.from(pbody?.querySelectorAll('td:nth-child(2) input')||[]).reduce((a,el)=>a+num(el.value),0));
    $('#payoutSum').textContent = fmt(payouts);

    const grossMode = document.querySelector('#enterGross')?.checked;
    const gross = r2(drop + coin);
    const actual = grossMode ? r2(gross - tax - payouts) : gross;
    const expected = r2((cash + debit - cashback - tax) - payouts);
    const diff = r2(actual - expected);

    // UI labels for mode
    const lbl = document.querySelector('#actualLabel');
    const sumLbl = document.querySelector('#sumActualLabel');
    const sumForm = document.querySelector('#sumActualFormula');
    const grossRow = document.querySelector('#grossRow');
    const grossCash = document.querySelector('#grossCash');
    if (lbl) lbl.textContent = grossMode ? 'Actual Deposit (after taxes & payouts)' : 'Actual Deposit (Σ Drop + Σ Coin ±)';
    if (sumLbl) sumLbl.textContent = grossMode ? 'Actual Deposit (after taxes & payouts)' : 'Actual Deposit';
    if (sumForm) sumForm.textContent = grossMode ? '= (Σ Drop + Σ Coin ±) − Taxes − Σ Payouts' : '= Σ Drop + Σ Coin ±';
    if (grossRow) grossRow.style.display = grossMode ? '' : 'none';
    if (grossCash) grossCash.textContent = fmt(gross);

    document.querySelector('#grossNote')?.classList.toggle('showing', !!grossMode);

    $('#actual').textContent = fmt(actual);
    $('#expected').textContent = fmt(expected);
    $('#diff').textContent = fmt(diff);

    $('#sumStore').textContent = $('#store')?.value || '—';
    const dt = $('#bizDate')?.value; $('#sumDate').textContent = dt ? new Date(dt+'T00:00').toLocaleDateString() : '';
    $('#sumActual').textContent = fmt(actual);
    $('#sumExpected').textContent = fmt(expected);
    $('#sumDiff').textContent = fmt(diff);
    const status = $('#sumStatus'); const abs = Math.abs(diff);
    status.textContent = abs < 0.01 ? 'OK' : (diff>0 ? 'Over' : 'Short');
    status.className = 'pill ' + (abs<0.01 ? 'ok' : 'bad');
  }

  function addPayoutRow(desc='', amount=''){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><input class="pdesc" placeholder="Description" value="${desc}"></td>
      <td class="right"><input class="pamt" inputmode="decimal" placeholder="0.00" value="${amount}"></td>
      <td class="center"><button class="btn sub" type="button">Remove</button></td>`;
    tr.querySelector('button')?.addEventListener('click', ()=>{ tr.remove(); recalc(); });
    pbody?.appendChild(tr);
  }
  function clearPayouts(){ if(pbody){ pbody.innerHTML=''; recalc(); } }
  function applyStoreDefaults(){
    const store = $('#store')?.value;
    clearPayouts();
    (DEFAULTS[store]||[]).forEach(([d,a])=> addPayoutRow(d,a));
    recalc();
  }

  function addShiftRow(note='', drop='', coin=''){
    const idx = (sbody?.children.length||0) + 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="mono">${idx}</td>
      <td><input placeholder="Name / notes" value="${note}"/></td>
      <td class="right"><input inputmode="decimal" placeholder="0.00" value="${drop}"/></td>
      <td class="right"><input inputmode="decimal" placeholder="0.00" value="${coin}"/></td>
      <td class="center"><button class="btn sub" type="button">Remove</button></td>`;
    tr.querySelector('button')?.addEventListener('click', ()=>{ tr.remove(); renumber(); recalc(); });
    sbody?.appendChild(tr);
  }
  function renumber(){ Array.from(sbody?.children||[]).forEach((tr,i)=> tr.firstElementChild.textContent = (i+1)); }

  // Seed initial rows
  for(let i=0;i<3;i++) addShiftRow();

  // Wire buttons
  $('#addPayout')?.addEventListener('click', ()=> addPayoutRow());
  $('#clearPayouts')?.addEventListener('click', clearPayouts);
  $('#applyDefaults')?.addEventListener('click', applyStoreDefaults);
  $('#addShift')?.addEventListener('click', ()=> addShiftRow());
  $('#clearShifts')?.addEventListener('click', ()=>{ if(sbody){ sbody.innerHTML=''; recalc(); } });

  // Store change -> defaults
  $('#store')?.addEventListener('change', applyStoreDefaults);

  // Live recalc
  document.addEventListener('input', e=>{ if(e.target.matches('input,select')) recalc(); });

  // Toggle recalc for gross mode
  document.querySelector('#enterGross')?.addEventListener('change', recalc);

  // Clipboard paste
  $('#btnPaste')?.addEventListener('click', async ()=>{
    try{
      const raw = await navigator.clipboard.readText();
      if(!raw){ alert('Clipboard empty.'); return; }
      const text = raw.replace(/\u00a0/g,' ');

      // Store detection if empty
      const low = text.toLowerCase();
      const storeSel = $('#store');
      if(storeSel && !storeSel.value){
        if(low.includes('sandy')) storeSel.value='Sandy';
        else if(low.includes('foster')) storeSel.value='Foster';
        else if(low.includes('division')) storeSel.value='Division';
        applyStoreDefaults();
      }

      const pull = (label)=>{
        const re = new RegExp(label+`\\s*[:\\-]?\\s*([$\\-0-9,\\.]+)`, 'i');
        const m = text.match(re);
        return m? m[1] : null;
      };

      const cash = pull('cash\\b');
      const cashback = pull('cashback\\b');
      const debit = pull('debit(?:\\s*card)?\\b');
      const taxRow = text.match(/oregon\s*state\s*marijuana\s*tax[^$0-9]*([$0-9,\.]+)/i);

      if(cash) $('#cashTotal').value = cash;
      if(debit) $('#debitTotal').value = debit;
      if(cashback) $('#cashbackTotal').value = cashback;
      if(taxRow) $('#taxTotal').value = taxRow[1];

      recalc();
    }catch(e){
      console.error(e);
      alert('Clipboard read failed (browser permissions).');
    }
  });

  // First pass
  applyStoreDefaults();
  recalc();

  // Export & print
  function buildData(){
    const store = $('#store')?.value||'Unknown';
    const dt = $('#bizDate')?.value||'';
    const cash = $('#cashTotal')?.value||'';
    const debit = $('#debitTotal')?.value||'';
    const cashback = $('#cashbackTotal')?.value||'';
    const tax = $('#taxTotal')?.value||'';
    const actual = $('#actual')?.textContent||'$0.00';
    const expected = $('#expected')?.textContent||'$0.00';
    const diff = $('#diff')?.textContent||'$0.00';
    const payoutRows = Array.from(pbody?.querySelectorAll('tr')||[]).map(tr=>[
      tr.children[0].querySelector('input')?.value||'',
      tr.children[1].querySelector('input')?.value||'',
    ]);
    const shiftRows = Array.from(sbody?.querySelectorAll('tr')||[]).map((tr,i)=>[
      i+1,
      tr.children[1].querySelector('input')?.value||'',
      tr.children[2].querySelector('input')?.value||'',
      tr.children[3].querySelector('input')?.value||'',
    ]);
    const changeBag = $('#changeBag')?.value||'';
    const changeNote = $('#changeNote')?.value||'';
    return {store, dt, cash, debit, cashback, tax, payoutRows, shiftRows, actual, expected, diff, changeBag, changeNote};
  }

  function rowsToCSV(rows){
    return rows.map(r=> r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\\r\\n');
  }

  $('#exportBtn')?.addEventListener('click', ()=>{
    const D = buildData();

    if (window.XLSX){
      const wb = XLSX.utils.book_new();

      const summary = [
        ['Store', D.store],
        ['Date', D.dt],
        ['Entry Mode', (document.querySelector('#enterGross')?.checked ? 'Gross (Pre-Pull)' : 'Net (Post-Pull)')],
        [],
        ['POS Totals'],
        ['Cash Total', D.cash],
        ['Debit Total', D.debit],
        ['Cashback Given', D.cashback],
        ['Taxes', D.tax],
        [],
        ['Results'],
        ['Gross Closing Cash (Σ Drop + Σ Coin ±)', document.querySelector('#grossCash')?.textContent || '$0.00'],
        ['Actual Deposit', D.actual],
        ['POS Net After Bills', D.expected],
        ['Difference', D.diff],
        [],
        ['Change Bag (note only)', D.changeBag, D.changeNote],
      ];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'Summary');

      const shifts = [['#','Employee / Notes','Shift Cash Drop (bills)','Shift Coin ±'], ...D.shiftRows];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(shifts), 'Shifts');

      const payouts = [['Description','Amount'], ...D.payoutRows, ['Total Payouts', document.querySelector('#payoutSum')?.textContent||'$0.00']];
      XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(payouts), 'Payouts');

      const fname = `DG-Deposit_${D.store}_${D.dt||'date'}.xlsx`.replace(/\\s+/g,'-');
      XLSX.writeFile(wb, fname);
    } else {
      const rows = [
        ['DG Tools — Daily Deposit (Simple v3.3)'],
        ['Store', D.store],
        ['Date', D.dt],
        ['Entry Mode', (document.querySelector('#enterGross')?.checked ? 'Gross (Pre-Pull)' : 'Net (Post-Pull)')],
        [],
        ['POS Totals'],
        ['Cash Total', D.cash],
        ['Debit Total', D.debit],
        ['Cashback Given', D.cashback],
        ['Taxes', D.tax],
        [],
        ['Vendor Payouts / Bills'],
        ['Description','Amount'],
        ...D.payoutRows,
        ['Total Payouts', document.querySelector('#payoutSum')?.textContent||'$0.00'],
        [],
        ['Shifts'],
        ['#','Employee / Notes','Shift Cash Drop (bills)','Shift Coin ±'],
        ...D.shiftRows,
        [],
        ['Change Bag (note only)', D.changeBag, D.changeNote],
        [],
        ['Results'],
        ['Gross Closing Cash (Σ Drop + Σ Coin ±)', document.querySelector('#grossCash')?.textContent || '$0.00'],
        ['Actual Deposit', D.actual],
        ['POS Net After Bills', D.expected],
        ['Difference', D.diff],
      ];
      const csv = rowsToCSV(rows);
      const blob = new Blob([csv], {type:'text/csv'});
      const name = `DG-Deposit_${D.store}_${D.dt||'date'}.csv`.replace(/\\s+/g,'-');
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=name; a.click(); URL.revokeObjectURL(a.href);
    }
  });

  $('#printBtn')?.addEventListener('click', ()=> window.print());
});
</script>

<!-- To enable .xlsx export on GitHub Pages, include SheetJS (uncomment the next line): -->
<!-- <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.2/dist/xlsx.full.min.js"></script> -->

</body>
</html>
